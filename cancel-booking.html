<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PheraSpace — Cancel Booking</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root{ --bg1:#090d1a; --bg2:#180a2c; --pink:#ff7ce9; --aqua:#26ffd9; --text:#e8f0ff; --muted:#9faac7; --radius:14px; }
body{ margin:0; padding:20px; background:linear-gradient(135deg,var(--bg1),var(--bg2)); color:var(--text); font-family:"Inter",sans-serif; }
.container{ max-width:650px; margin:auto; background:rgba(255,255,255,0.08); padding:25px; border-radius:var(--radius); border:1px solid rgba(255,255,255,0.12); }
h1{ text-align:center; background:linear-gradient(90deg,var(--pink),var(--aqua)); -webkit-background-clip:text; color:transparent; }
.alert{ background:rgba(255,100,100,0.2); border:1px solid rgba(255,100,100,0.4); padding:12px; border-radius:var(--radius); margin-top:10px; }
.ok{ background:rgba(80,255,160,0.2); border:1px solid rgba(80,255,160,0.4); padding:12px; border-radius:var(--radius); margin-top:10px; }
.btn{ width:100%; padding:14px; margin-top:15px; border:none; border-radius:var(--radius); font-weight:700; cursor:pointer; color:#111; }
.cancel-btn{ background:linear-gradient(90deg,#ff5050,#ff7c7c); }
.back-btn{    background:linear-gradient(90deg,var(--pink),var(--aqua)); }
</style>
</head>
<body>
<div class="container">
  <h1>Cancel Booking</h1>
  <div id="info"></div>
  <button id="confirmBtn" class="btn cancel-btn">Confirm Cancellation</button>
  <button class="btn back-btn" onclick="location.href='user-dashboard.html'">Back to Dashboard</button>
</div>

<script>
function q(k){ return new URLSearchParams(location.search).get(k); }
function toDate(d){ return new Date(d + "T00:00:00"); }
function addDays(d,n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function today(){ const d=new Date(); return new Date(d.getFullYear(),d.getMonth(),d.getDate()); }
function parseAmount(a){ return Number(String(a).replace(/[₹,\s]/g,''))||0; }
function fmt(n){ return Number(n||0).toLocaleString('en-IN'); }

const id = q('id') || localStorage.getItem('lastBookingID');
let allBookings = JSON.parse(localStorage.getItem('allBookings')||'[]');
const idx = allBookings.findIndex(b=>b.bookingID===id);
const infoBox = document.getElementById('info');
const btn = document.getElementById('confirmBtn');

if(idx<0){
  infoBox.innerHTML = `<div class="alert">No booking found for this link.</div>`;
  btn.disabled = true; btn.style.opacity = 0.5;
} else {
  const b = allBookings[idx];
  const cutoff = addDays(toDate(b.eventDate), -2);
  const eligible = today().getTime() <= cutoff.getTime();
  const refundAmt = Math.round(parseAmount(b.totalPrice)*0.80);

  infoBox.innerHTML = eligible ? `
    <div class="ok">
      <p><strong>Booking ID:</strong> ${b.bookingID}</p>
      <p><strong>Hall:</strong> ${b.hallName}</p>
      <p><strong>Event:</strong> ${b.eventDate} • ${b.timeSlot}</p>
      <p><strong>Refund:</strong> ₹${fmt(refundAmt)} (80%)</p>
      <p><strong>Cancel before:</strong> ${cutoff.toLocaleDateString()}</p>
    </div>
  ` : `
    <div class="alert">
      <p><strong>Booking ID:</strong> ${b.bookingID}</p>
      <p>❌ Cancellation deadline passed (free cancellation allowed only until ${cutoff.toLocaleDateString()}).</p>
    </div>
  `;

  if(!eligible || b.status!=="Confirmed"){ btn.disabled = true; btn.style.opacity=0.5; }

  btn.addEventListener('click', ()=>{
    if(btn.disabled) return;
    const now = new Date();
    allBookings[idx] = {
      ...b,
      status: "Cancelled",
      cancellationDate: now.toLocaleDateString(),
      refundAmount: refundAmt,
      refundStatus: "Initiated"
    };
    localStorage.setItem('allBookings', JSON.stringify(allBookings));
    alert("✅ Booking cancelled. Refund initiated.");
    location.href = `refund-status.html?id=${b.bookingID}`;
  });
}
</script>
</body>
</html>
